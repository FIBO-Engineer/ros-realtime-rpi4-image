Latency analysis scripts and setup
==================================

The scripts here are used to test and analyze the scheduling latency of each Raspberry Pi release. Latency experiments are performed with two parts:

1. Run CPU stress and cyclictest on the Raspberry Pi to obtain the latency histogram.
2. Run the analysis Jupyter notebook to draw the plots with the histogram file.

To run cyclictest, run the `run_latency_experiment.sh` shell script on the Raspberry Pi 4. This will need PASSWORD-LESS sudo to both install a few small packages as well as to obtain priviledges for RT scheduling. This will spawn a `tmux` window where a CPU stress test is happening at the same time as a cyclictest run [^1]. 

Once the test is done (defaults to 2 hours), a file named something like `22.04_5.15.39-rt42-raspi.log` will be created in the `data` directory. You then need to use the Jupyter notebook to draw the latency plot.

To do this, make sure you installed `jupyterlab` and `numpy`. Then, in this directory, simply run `jupyter lab` and open [`analysis.ipynb`](./analysis.ipynb). One way to install `jupyterlab` maybe via [miniconda](https://docs.conda.io/en/latest/miniconda.html) and using the `environment.yml` file provided here.

Once Jupyter lab is loaded, simply tweak the Python source code and run it to get the plots. The existing notebook should automatically save a PNG to the `data` directory. This can be committed into the repo for a permanent record. 

When releasing an image, include a plot generated by this for record keeping.

[^1]: Technically, things other than just a CPU stress test can cause additional latency. However, based on my [previous investigations](https://github.com/cactusdynamics/cactus-rt/blob/master/data/cyclictest-rpi4/plot.ipynb), CPU stress is likely the worst case scenario for the Raspberry Pi 4, at least with Ubuntu 20.04 and Kernel 5.4. It is possible that future kernels can introduce regression. However, such testing would be very expensive to perform as a very large matrix of synthetic load can be created.
